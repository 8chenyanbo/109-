<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>管理員介面</title>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <div class="card">
    <h2>管理員介面</h2>
    <p>目前座號：<span id="current-seat">--</span></p>
    <table id="grades-table">
      <thead><tr><th>座號</th><th>科目</th><th>分數</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>

    <h3>新增科目</h3>
    <input type="text" id="new-subject" placeholder="科目名稱" />
    <button onclick="addSubject()">新增</button>

    <h3>指定編輯者</h3>
    <input type="text" id="editor-seat" placeholder="座號" />
    <button onclick="assignEditor()">指定</button>

    <h3>匯出成績 JSON</h3>
    <textarea id="backup-json" rows="6" style="width:100%;"></textarea>
    <button onclick="exportGrades()">匯出</button>
  </div>

  <script>
    const seat = localStorage.getItem("seat");
    document.getElementById("current-seat").textContent = seat || "--";

    let grades = JSON.parse(localStorage.getItem("grades") || "{}");
    let editors = JSON.parse(localStorage.getItem("editors") || "[]");
    const isAdmin = seat === "114129";
    const isEditor = editors.includes(seat);

    if (!localStorage.getItem("grades")) {
      localStorage.setItem("grades", JSON.stringify({
        "114121": { "國文": 80, "英文": 75, "數學": 88 },
        "114129": { "國文": 92, "英文": 95, "數學": 98 }
      }));
      grades = JSON.parse(localStorage.getItem("grades"));
    }

    const tbody = document.querySelector("#grades-table tbody");
    for (let sid in grades) {
      for (let subject in grades[sid]) {
        const score = grades[sid][subject];
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${sid}</td>
          <td>${subject}</td>
          <td><input type="number" value="${score}" ${(!isAdmin && !isEditor) ? "disabled" : ""}></td>
          <td><button onclick="editGrade('${sid}','${subject}', this.parentElement.parentElement.querySelector('input').value)">更新</button></td>
        `;
        tbody.appendChild(row);
      }
    }

    function editGrade(sid, subject, score) {
      if (!isAdmin && !isEditor) return alert("無權限！");
      grades[sid][subject] = parseInt(score);
      localStorage.setItem("grades", JSON.stringify(grades));
      alert("已更新！");
    }

    function addSubject() {
      if (!isAdmin) return alert("無權限！");
      const subject = document.getElementById("new-subject").value.trim();
      if (!subject) return;
      for (let sid in grades) {
        if (grades[sid][subject] === undefined) {
          grades[sid][subject] = 0;
        }
      }
      localStorage.setItem("grades", JSON.stringify(grades));
      location.reload();
    }

    function assignEditor() {
      if (!isAdmin) return alert("無權限！");
      const editor = document.getElementById("editor-seat").value.trim();
      if (editor && !editors.includes(editor)) {
        editors.push(editor);
        localStorage.setItem("editors", JSON.stringify(editors));
        alert("已指定編輯者：" + editor);
      }
    }

    function exportGrades() {
      document.getElementById("backup-json").value = localStorage.getItem("grades") || "{}";
    }
  </script>
</body>
</html>
